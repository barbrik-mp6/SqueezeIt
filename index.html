<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Photo Compressor — Privacy First</title>
<!-- This MUST be the first script to ensure the Telegram object is available -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<meta name="theme-color" content="#111111">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Karma:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #111111; --card: #1a1a1a; --text: #f0f0f0; --muted: #888888;
    --accent: #8A63D2; --stroke: #2f2f2f; --success: #34d399; --danger: #f47174;
    --space-sm: 8px; --space-md: 16px; --space-lg: 24px; --space-xxl: 48px;
    --radius: 12px;
  }
  html { color-scheme: dark; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: 'Karma', system-ui, sans-serif;
    background: var(--bg); color: var(--text);
    -webkit-font-smoothing:antialiased;
    padding: var(--space-lg);
    padding-bottom: 80px; /* Add padding for Telegram's Main Button */
    transition: background-color .2s ease;
  }
  .app{ max-width:1600px; margin:0 auto; }
  header{ display:flex; gap: var(--space-md); align-items:center; margin-bottom: var(--space-lg); }
  .logo { width:48px; height:48px; border-radius:10px; background:var(--accent); display:flex; align-items:center; justify-content:center; flex:0 0 48px; }
  .logo svg{width:26px; height:26px;}
  h1{font-size:22px; margin:0; font-weight: 700;}
  p.lead{margin:0;color:var(--muted);font-size:15px; font-weight: 400;}
  .grid{ display:grid; grid-template-columns: minmax(360px, 420px) 1fr 1fr; gap: var(--space-lg); align-items:start; }
  .card{ background:var(--card); border-radius:var(--radius); padding: var(--space-lg); border: 1px solid var(--stroke); }
  .card-header{ display:flex; justify-content:space-between; align-items:center; font-size: 16px; font-weight: 600; }
  .control-group { margin-bottom: var(--space-lg); }
  .control-group:last-child { margin-bottom: 0; }
  label{display:block; font-size:15px; color:var(--muted); margin-bottom:var(--space-sm); font-weight:400;}
  input[type="number"], select{ width:100%; padding: 12px var(--space-md); border-radius: var(--space-sm); border: 1px solid var(--stroke); background: var(--bg); color:var(--text); font-size:16px; font-family: 'Karma', system-ui, sans-serif; transition: border-color .2s ease; }
  input[type="number"]:focus, select:focus { border-color: var(--accent); outline: none; }
  select option { background: var(--bg); color: var(--text); }
  .chip-group{display:flex;gap:var(--space-sm);}
  .chip{ padding:var(--space-sm) 12px; border-radius: var(--radius); background:var(--bg); font-size:14px; cursor:pointer; border:1px solid var(--stroke); transition: all .2s ease; user-select: none; }
  .chip:hover { border-color:var(--muted); }
  .chip.active{ background:var(--accent); border-color:var(--accent); color:white; font-weight:600; }
  .slider-container { display: flex; align-items: center; gap: var(--space-md); }
  input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: var(--stroke); border-radius: 6px; outline: none; padding: 0; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--text); cursor: pointer; border-radius: 50%; border: 2px solid var(--card); transition: background .2s ease; }
  input[type="range"]::-moz-range-thumb { width: 16px; height: 16px; background: var(--text); cursor: pointer; border-radius: 50%; border: 2px solid var(--card); }
  input[type="range"]:hover::-webkit-slider-thumb { background: var(--accent); }
  #qualityValue { font-weight:600; font-size: 16px; min-width: 40px; text-align: right; }
  .color-control { display:flex; align-items:center; gap:var(--space-sm); }
  input[type="checkbox"] { display: none; }
  .checkbox-label { width: 18px; height: 18px; border: 2px solid var(--stroke); border-radius: 4px; display: inline-block; cursor: pointer; transition: all .2s ease; }
  input[type="checkbox"]:checked + .checkbox-label { background-color: var(--accent); border-color: var(--accent); }
  input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 32px; height: 32px; background-color: transparent; border: none; cursor: pointer; padding: 0; border-radius: 8px; overflow: hidden; }
  input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; border-radius: 8px; }
  input[type="color"]::-webkit-color-swatch { border: 2px solid var(--stroke); border-radius: 8px; }
  .actions{display:flex; flex-direction: column; gap:var(--space-sm); margin-top:var(--space-lg);}
  .btn { width: 100%; padding:14px; border-radius:var(--space-sm); cursor:pointer; font-weight:600; font-size:15px; font-family: 'Karma', system-ui, sans-serif; transition: all .2s ease; }
  .btn-primary { border:0; background:var(--accent); color:white; }
  .btn-primary:hover { background: #714db2; }
  .btn-secondary { background:transparent; border:1px solid var(--stroke); color:var(--text); }
  .btn-secondary:hover { border-color: var(--muted); background: rgba(255,255,255,0.05); }
  .btn:disabled{opacity:.4; cursor:not-allowed; background: var(--stroke); border-color: var(--stroke);}
  .drop{ border:2px dashed var(--stroke); border-radius:var(--radius); padding:var(--space-xxl) var(--space-lg); text-align:center; cursor:pointer; transition:all .2s ease; }
  .drop.drag, .drop:hover { border-color:var(--accent); background: #151515; }
  .drop .big{ display:flex; align-items:center; justify-content:center; gap:var(--space-sm);color:var(--text);font-weight:600;font-size:16px; }
  .muted{color:var(--muted);font-size:14px;margin-top:var(--space-sm)}
  .preview-card img{ width:100%; border-radius:var(--radius); display:block; object-fit:contain; max-height:520px; }
  .preview-wrapper{ background: var(--bg); padding:var(--space-md); border-radius:var(--radius); display:flex;align-items:center;justify-content:center;min-height:350px; }
  .meta{ display:flex; justify-content:space-between; gap:var(--space-md); margin-top: var(--space-md); }
  .meta > div { flex: 1; background: var(--bg); padding: var(--space-sm) 12px; border-radius: var(--space-sm); }
  .meta .value { font-weight: 600; color: var(--text); font-size: 15px; margin-top: 4px; }
  footer{margin-top:var(--space-lg);color:var(--muted);font-size:13px; text-align: center;}
  @media (max-width:1100px){ body { padding: var(--space-lg); padding-bottom: 80px; } .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M17 8l-5-5-5 5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 3v12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
      <div><h1>Photo Compressor</h1><p class="lead">Optimized for quality, privacy, and performance.</p></div>
    </header>

    <main class="grid">
      <section class="card">
        <div class="control-group"><div id="dropArea" class="drop" tabindex="0"><div class="big"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" stroke="currentColor" stroke-width="2"/><path d="M17 8l-5-5-5 5M12 3v12" stroke="currentColor" stroke-width="2"/></svg> Drop Image or Click</div><div class="muted">100% private and offline.</div><input id="fileInput" type="file" accept="image/jpeg,image/png,image/webp,image/gif,image/bmp" style="display:none" /></div></div>
        <div class="control-group"><label>Compression Priority</label><div class="chip-group"><div id="prioritySize" class="chip active">File Size</div><div id="priorityQuality" class="chip">Quality</div></div></div>
        <div id="sizePriorityControls" class="control-group"><label for="targetSize">Target Size (KB)</label><input id="targetSize" type="number" min="1" value="500" /></div>
        <div id="qualityPriorityControls" class="control-group" style="display:none;"><label for="qualitySlider">Quality</label><div class="slider-container"><input id="qualitySlider" type="range" min="1" max="100" value="85"><span id="qualityValue">85</span></div></div>
        <div class="control-group"><label for="format">Output Format</label><select id="format"><option value="webp">WebP (Recommended)</option><option value="jpeg">JPEG</option><option value="png">PNG (Best for Graphics)</option></select></div>
        <div class="control-group"><label>Background</label><div class="chip-group"><div id="bgRemove" class="chip">Remove</div><div class="color-control"><input type="checkbox" id="bgColorToggle"><label class="checkbox-label" for="bgColorToggle"></label><label for="bgColorToggle" style="margin-bottom:0;cursor:pointer;">Fill</label><input type="color" id="bgColorPicker" value="#FFFFFF"></div></div></div>
        <div class="actions"><button id="processBtn" class="btn btn-primary">Compress Image</button><button id="downloadBtn" class="btn btn-secondary" disabled>Download</button><button id="installBtn" class="btn btn-secondary" style="display:none;">Download App</button></div>
        <div id="progressWrap" style="display:none;margin-top:16px;height:6px;background:var(--stroke);border-radius:6px;overflow:hidden;"><div id="progress" style="height:100%;width:0;background:var(--accent);transition:width .2s linear"></div></div>
      </section>
      <section class="card"><div class="card-header"><div>Original</div><div id="origType" class="muted">—</div></div><div class="preview-wrapper" style="margin-top:16px;"><img id="origImg" alt="Original preview" style="display:none" /><div id="origPlaceholder" class="muted">No image selected</div></div><div class="meta"><div><span class="muted">Size</span><div id="origSize" class="value">—</div></div><div><span class="muted">Dimensions</span><div id="origDims" class="value">—</div></div></div></section>
      <section class="card"><div class="card-header"><div>Result</div><div id="resType" class="muted">—</div></div><div class="preview-wrapper" style="margin-top:16px;"><img id="resImg" alt="Result preview" style="display:none" /><div id="resPlaceholder" class="muted">Awaiting compression</div></div><div class="meta"><div><span class="muted">New Size</span><div id="resSize" class="value">—</div></div><div><span class="muted">Savings</span><div id="resRatio" class="value" style="color:var(--success)">—</div></div></div></section>
    </main>
    <footer class="notes-section muted">This is a single-file, installable web application. Your data never leaves your computer.</footer>
  </div>

<script>
// --- Global State & Element Refs ---
const $ = (id) => document.getElementById(id);
let currentObjectURL=null, processedBlob=null, origFile=null, originalBitmap=null;
let tg = window.Telegram?.WebApp;

const dropArea=$('dropArea'),fileInput=$('fileInput'),processBtn=$('processBtn'),downloadBtn=$('downloadBtn'),installBtn=$('installBtn');
const progress=$('progress'),progressWrap=$('progressWrap');
const origImg=$('origImg'),origPlaceholder=$('origPlaceholder'),origSize=$('origSize'),origDims=$('origDims'),origType=$('origType');
const resImg=$('resImg'),resPlaceholder=$('resPlaceholder'),resSize=$('resSize'),resRatio=$('resRatio'),resType=$('resType');
const targetSizeInput=$('targetSize'),formatSelect=$('format');
const prioritySizeBtn=$('prioritySize'),priorityQualityBtn=$('priorityQuality');
const sizePriorityControls=$('sizePriorityControls'),qualityPriorityControls=$('qualityPriorityControls');
const qualitySlider=$('qualitySlider'),qualityValue=$('qualityValue');
const bgRemove=$('bgRemove'),bgColorToggle=$('bgColorToggle'),bgColorPicker=$('bgColorPicker');

// --- Core App Logic (unchanged) ---
function setPriority(mode){const t=mode==='size';prioritySizeBtn.classList.toggle('active',t),priorityQualityBtn.classList.toggle('active',!t),sizePriorityControls.style.display=t?'block':'none',qualityPriorityControls.style.display=t?'none':'block',handleFormatChange()}
function handleFormatChange(){const t=priorityQualityBtn.classList.contains('active'),e=formatSelect.value==='png';qualitySlider.disabled=t&&e,qualityValue.style.opacity=qualitySlider.disabled?.5:1}
async function setOriginalFile(t){originalBitmap&&originalBitmap.close();try{originalBitmap=await createImageBitmap(t)}catch(t){return void showTemporaryNote("Error: Unsupported or corrupt file.",4E3)}origFile=t,currentObjectURL&&URL.revokeObjectURL(currentObjectURL),currentObjectURL=URL.createObjectURL(t),origImg.src=currentObjectURL,origImg.style.display='block',origPlaceholder.style.display='none',origSize.textContent=(t.size/1024).toFixed(1)+' KB',origType.textContent=t.type.replace('image/','').toUpperCase()||'IMAGE',origDims.textContent=originalBitmap.width+'×'+originalBitmap.height,clearResult();tg?.MainButton.setText("Compress Image").show()}
async function coreProcessImage(){if(!origFile||!originalBitmap)return void alert('Please choose a valid image first');processBtn.disabled=!0,downloadBtn.disabled=!0,processedBlob=null,resImg.style.display='none',resPlaceholder.textContent='Processing…',progressWrap.style.display='block',setProgress(6),resSize.style.color='var(--text)',resRatio.style.color='var(--success)';try{const t=formatSelect.value||'webp',e={removeBg:bgRemove.classList.contains('active'),bgColor:bgColorToggle.checked?bgColorPicker.value:null,progressCallback:setProgress};let o;if(prioritySizeBtn.classList.contains('active')){const i=Math.max(1,Math.round(Number(targetSizeInput.value)||0))*1024;o=await compressToTargetWithScale(i,t,e),o.size>i&&(showTemporaryNote('Could not meet target size.',4E3),resSize.style.color='var(--danger)',resRatio.style.color='var(--danger)')}else{const i=parseInt(qualitySlider.value,10)/100;o=await compressWithQualityPriority(i,t,e)}if(!o)throw new Error('Compression failed.');processedBlob=o,displayResult(o)}catch(t){resPlaceholder.textContent='Error: '+(t.message||t),tg?.HapticFeedback.notificationOccurred('error')}finally{processBtn.disabled=!1,setTimeout(()=>{progressWrap.style.display='none',setProgress(0)},700)}}
async function compressWithQualityPriority(t,e,o){return o.progressCallback(25),await encodeCanvasBitmap(originalBitmap,originalBitmap.width,originalBitmap.height,e,t,o)}
async function compressToTargetWithScale(t,e,o){const{progressCallback:i}=o,r=originalBitmap.width,n=originalBitmap.height;i(20);let a=await binarySearchQuality(originalBitmap,r,n,t,e,o);if(a&&a.size<=t)return a;let s=.95;for(let l=0;l<15;l++){i(30+Math.min(60,4*l));const c=Math.max(1,Math.round(r*s)),d=Math.max(1,Math.round(n*s)),p=await binarySearchQuality(originalBitmap,c,d,t,e,o);if(p&&(a&&p.size>=a.size||(a=p)),a&&a.size<=t)return a;if(c<=128||d<=128)break;const u=a?a.size/t:2;s*=.9<u?1.5:.85}if(a)return a;throw new Error('Could not generate an image.')}
async function binarySearchQuality(t,e,o,i,r,n){if('png'===r)return await encodeCanvasBitmap(t,e,o,r,.9,n);let a,s=.01,l=1;for(let c=0;c<8;c++){const d=(s+l)/2,p=await encodeCanvasBitmap(t,e,o,r,d,n);if(!p)break;p.size<=i?(a=p,s=d):l=d}return a}
async function encodeCanvasBitmap(t,e,o,i,r=.9,n={}){const{bgColor:a=null,removeBg:s=!1}=n,l=document.createElement('canvas');l.width=e,l.height=o;const c=l.getContext('2d');if(a&&!s&&(c.fillStyle=a,c.fillRect(0,0,e,o)),c.drawImage(t,0,0,e,o),s)try{const d=c.getImageData(0,0,e,o);let p=0,u=0,m=0;[[0,0],[e-1,0],[0,o-1],[e-1,o-1]].forEach(([t,i])=>{const r=(i*e+t)*4;p+=d.data[r],u+=d.data[r+1],m+=d.data[r+2]}),p/=4,u/=4,m/=4;const g=30;for(let f=0;f<d.data.length;f+=4)Math.abs(d.data[f]-p)<g&&Math.abs(d.data[f+1]-u)<g&&Math.abs(d.data[f+2]-m)<g&&(d.data[f+3]=0);c.putImageData(d,0,0)}catch(t){}const h='jpeg'===i?'image/jpeg':'png'===i?'image/png':'image/webp';return new Promise(t=>l.toBlob(t,h,r))}
function coreDisplayResult(t){currentObjectURL&&URL.revokeObjectURL(currentObjectURL),currentObjectURL=URL.createObjectURL(t),resImg.src=currentObjectURL,resImg.style.display='block',resPlaceholder.style.display='none',resSize.textContent=(t.size/1024).toFixed(1)+' KB',resType.textContent=t.type.replace('image/','').toUpperCase();const e=(origFile.size-t.size)/origFile.size*100;resRatio.textContent=(e>-1/0?e.toFixed(1):0)+'%',downloadBtn.disabled=!1,setProgress(100)}
function coreDownloadResult(){if(!processedBlob||!origFile)return;let t;const e=(origFile.name.split('.').slice(0,-1).join('')||'image').replace(/[^a-zA-Z0-9]/g,'-'),o=formatSelect.value==='jpeg'?'jpg':formatSelect.value;if(prioritySizeBtn.classList.contains('active'))t=`${e}-Compressed-${targetSizeInput.value}KB.${o}`;else{let i=tg?.initDataUnsafe?.user?.first_name||'';i&&(t=`${e}-for-${i}-Q${qualitySlider.value}.${o}`),t||(t=`${e}-Compressed-Q${qualitySlider.value}.${o}`)}const i=document.createElement('a');i.href=URL.createObjectURL(processedBlob),i.download=t,i.click(),i.remove(),URL.revokeObjectURL(i.href)}
function clearResult(){processedBlob=null,resImg.src='',resImg.style.display='none',resPlaceholder.style.display='block',resPlaceholder.textContent='Awaiting compression',resSize.textContent='—',resType.textContent='—',resRatio.textContent='—',downloadBtn.disabled=!0,resSize.style.color='var(--text)',resRatio.style.color='var(--success)'}
function setProgress(t){progress.style.width=Math.max(0,Math.min(100,t))+'%'}
function showTemporaryNote(t,e=3E3){const o=document.createElement('div');o.textContent=t,o.style.cssText="position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:#222;backdrop-filter:blur(5px);color:white;padding:10px 16px;border-radius:8px;font-size:14px;z-index:9999;font-family:'Karma',system-ui,sans-serif;border:1px solid var(--stroke);",document.body.appendChild(o),setTimeout(()=>o.remove(),e)}

// --- PWA & Telegram Integration Layer ---
let processImage = coreProcessImage;
let displayResult = coreDisplayResult;
let downloadResult = coreDownloadResult;

function initializeTelegramIntegration(){
  if (tg && tg.platform !== 'unknown') {
    tg.ready();
    
    // --- UI & Theme ---
    const setTheme = () => { document.body.style.backgroundColor = tg.themeParams.bg_color || '#111111'; };
    tg.onEvent('themeChanged', setTheme);
    setTheme();

    processBtn.style.display = 'none'; // Hide original button
    tg.MainButton.setText("Select an Image").disable().show();
    tg.onEvent('mainButtonClicked', () => { tg.HapticFeedback.impactOccurred('medium'); processImage(); });

    // --- Wrap Core Functions for Telegram ---
    processImage = async () => {
        tg.MainButton.showProgress(false).disable();
        await coreProcessImage();
        tg.MainButton.hideProgress();
    };
    displayResult = (result) => {
        coreDisplayResult(result);
        downloadBtn.style.display = 'block'; // Show download button inside app
        tg.MainButton.setText("Done & Close").enable().onClick(() => tg.close());
        tg.HapticFeedback.notificationOccurred('success');
    };
    downloadResult = () => {
        tg.HapticFeedback.impactOccurred('light');
        coreDownloadResult();
    };
  }
}

function setupPWA(){const t='M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4 M17 8l-5-5-5 5 M12 3v12',e=e=>{const o=document.createElement('canvas');o.width=e,o.height=e;const i=o.getContext('2d');return i.scale(e/24,e/24),i.strokeStyle='#f0f0f0',i.lineWidth=1.5,i.lineCap='round',i.lineJoin='round',i.stroke(new Path2D(t)),o.toDataURL('image/png')},o={name:"Photo Compressor",short_name:"Compressor",description:"A privacy-first, offline-capable image compressor.",start_url:location.href.split('?')[0],display:"standalone",background_color:"#111111",theme_color:"#111111",icons:[{src:e(192),sizes:"192x192",type:"image/png"},{src:e(512),sizes:"512x512",type:"image/png"}]};const i=URL.createObjectURL(new Blob([JSON.stringify(o)],{type:'application/json'}));document.head.insertAdjacentHTML('beforeend',`<link rel="manifest" href="${i}">`),document.head.insertAdjacentHTML('beforeend',`<link rel="icon" href="${e(32)}">`);const r=`\n    const CACHE_NAME = 'compressor-cache-v1';\n    const urlsToCache = ['${location.href}'];\n    self.addEventListener('install', event => {\n      event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));\n    });\n    self.addEventListener('fetch', event => {\n      event.respondWith(caches.match(event.request).then(response => response || fetch(event.request)));\n    });\n  `,n=URL.createObjectURL(new Blob([r],{type:'application/javascript'}));'serviceWorker'in navigator&&navigator.serviceWorker.register(n)}

// --- App Initialization on Load ---
window.addEventListener('load',()=>{initializeTelegramIntegration();setupPWA();let t;window.addEventListener('beforeinstallprompt',e=>{!tg?.platform&&'unknown'!==tg?.platform&&(e.preventDefault(),t=e,installBtn.style.display='block')}),installBtn.addEventListener('click',async()=>{t&&(t.prompt(),await t.userChoice,t=null)})});

// --- Event Listeners ---
dropArea.addEventListener('click',()=>fileInput.click()),fileInput.addEventListener('change',t=>t.target.files&&t.target.files[0]&&setOriginalFile(t.target.files[0])),dropArea.addEventListener('dragover',t=>{t.preventDefault(),dropArea.classList.add('drag')}),dropArea.addEventListener('dragleave',t=>{dropArea.classList.remove('drag')}),dropArea.addEventListener('drop',t=>{t.preventDefault(),dropArea.classList.remove('drag'),t.dataTransfer.files[0]&&setOriginalFile(t.dataTransfer.files[0])}),processBtn.addEventListener('click',processImage),downloadBtn.addEventListener('click',downloadResult),qualitySlider.addEventListener('input',()=>{qualityValue.textContent=qualitySlider.value}),prioritySizeBtn.addEventListener('click',()=>setPriority('size')),priorityQualityBtn.addEventListener('click',()=>setPriority('quality')),formatSelect.addEventListener('change',handleFormatChange),bgRemove.addEventListener('click',()=>bgRemove.classList.toggle('active'));
</script>
</body>
</html>
